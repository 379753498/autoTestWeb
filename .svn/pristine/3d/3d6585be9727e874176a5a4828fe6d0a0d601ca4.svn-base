<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>客户管理</title>
<script>
	$(function() {
		findCustomerList();
	});
	function findCustomerList() {
		var table = $('#tableCustomerList')
				.DataTable(
						{
							"ordering":false,
							"searching":false,
							"ajax" : "manage/findCustomerList",
							"columns" : [
									{
										"data" : "id"
									},
									{
										"data" : "name"
									},
									{
										"data" : "code"
									},
									{
										"targets" : -1,//编辑
										"data" : null,
										"render" : function(data){
											var str="<span class='glyphicon glyphicon-pencil' onclick='showUpdateCustomerPanel(this)' style='cursor:pointer;'>"
											+ "</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class='glyphicon glyphicon-trash'  style='cursor:pointer;' onclick='deleteCustomer(this);'>"
											+ "</span>&nbsp;&nbsp;&nbsp;&nbsp;<a class='link'  style='cursor:pointer;' value='manage/initGroup?customerId="+data.id+"'>客户组</a>";
											return str;
										}
									} ],
									"oLanguage" : {
										"sLengthMenu" : "每页显示 _MENU_ 条记录",
										"sZeroRecords" : "抱歉， 没有找到",
										"sInfo" : "从 _START_ 到 _END_ 共 _TOTAL_ 条数据",
										"sInfoEmpty" : "没有数据",
										"sInfoFiltered" : "(从 _MAX_ 条数据中检索)",
										"oPaginate" : {
											"sFirst" : "首页",
											"sPrevious" : "前一页",
											"sNext" : "后一页",
											"sLast" : "尾页"
										}
									},
							"aoColumnDefs" : [ {
								sDefaultContent : '',
								aTargets : [ '_all' ]
							} ]
						});
		$('#tableCustomerList thead tr th')
				.each(
						function() {
							var title = $(this).text();
							if (title == "客户名称") {
								$(this)
										.html(
												'<input type="text" placeholder="'+title+'" />');
							}

						});
		table.columns().every(function() {
			var that = this;

			$('input', this.header()).on('keyup change', function() {
				if (that.search() !== this.value) {
					that.search(this.value).draw();
				}
			});
		});
	}
	function showAddCustomerPanel() {
		$("#btnUpdateCustomer").hide();
		$("#btnAddCustomer").show();
		$("#customerModalTitle").text("Customer添加");
		$('#customerModal').modal('show');
	}
	function addCustomer() {
		$.ajax({
			type : 'POST',
			url : "case/insertCustomer",
			data : {
				"customer.name" : $("#txtCustomerName").val(),
				"customer.code" : $("#txtCustomerCode").val()
			},
			async : false,
			success : function(data) {
				if (data > 0) {
					alert("添加成功");
					refresh($.cookie("url"));
					$('#customerModal').modal('hide');
				}
			}
		});

	}
	function redirectToGroup(obj) {
		var customerId = $(obj).parent("td").siblings().eq(0).text();
		window.location.href = "initGroup?customerId=" + customerId;
	}
	function showUpdateCustomerPanel(obj){
		var customerId = $(obj).parent("td").siblings().eq(0).text();
		$.ajax({
			type : 'POST',
			url : "manage/findCustomerById?customerId="+customerId,
			async : false,
			success : function(data) {
				$("#btnUpdateCustomer").show();
				$("#btnAddCustomer").hide();
				$("#txtCustomerId").val(customerId);
				$("#txtCustomerName").val(data["name"]);
				$("#txtCustomerCode").val(data["code"]);
				$('#customerModal').modal('show');
			}
		});
		
		
	}
	function updateCustomer(){
		$.ajax({
			type : 'POST',
			url : "manage/updateCustomer",
			data : {
				"customer.name" : $("#txtCustomerName").val(),
				"customer.id" : $("#txtCustomerId").val(),
				"customer.code" : $("#txtCustomerCode").val()
			},
			success : function(data) {
				if (data > 0) {
					alert("更新成功");
					refresh($.cookie("url"));
					$('#customerModal').modal('hide');
				}
			}
		});
	}
	function deleteCustomer(obj){
		if(confirm("确定要删除")){
			var customerId = $(obj).parent("td").siblings().eq(0).text();
			$.ajax({
				type : 'POST',
				url : "manage/deleteCustomer?customerId="+customerId,
				async : false,
				success : function(data) {
					if (data > 0) {
						alert("删除成功");
						refresh($.cookie("url"));
					}
				},  
				error : function() {   
		          	alert("删除失败,请联系开发人员");  
		          	refresh($.cookie("url"));
		      	}  
			});
		}
		
	}
</script>
</head>
<body>
	<div class="maincontent">
		<div class="mainheader">
			<div class="glyphicon glyphicon-plus right add" onclick="showAddCustomerPanel();"></div>
			<div class="clear"></div>
		</div>
		<div class="maincontent maincontenttop">
			<table id="tableCustomerList" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>序号</th>
						<th>客户名称</th>
						<th>Code</th>
						<th>操作</th>
					</tr>
				</thead>
				<tfoot>
					<tr>
						<th>序号</th>
						<th>客户名称</th>
						<th>Code</th>
						<th>操作</th>
					</tr>
				</tfoot>
			</table>
		</div>
		<div class="modal fade" id="customerModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						<h4 class="modal-title" id="customerModalTitle">Customer编辑</h4>
					</div>
					<div class="modal-body">
						<input type="hidden" id="txtCustomerId" />
						<div class='maincontent'>
							<lable>Customer名称</lable>
							<input type='text' id="txtCustomerName" />
						</div>
						<div class='maincontent'>
							<lable>Code</lable>
							<input type='text' id="txtCustomerCode" />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addCustomer();" id="btnAddCustomer">确定</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="updateCustomer();" id="btnUpdateCustomer">确定</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>

	</div>
</body>
</html>